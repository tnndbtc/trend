---
# Azure Key Vault Integration with External Secrets Operator
#
# Prerequisites:
#   1. Install External Secrets Operator (see README.md)
#   2. Create Azure Key Vault:
#      az keyvault create --name trend-platform-vault --resource-group trend-platform
#   3. Store secrets in Key Vault:
#      az keyvault secret set --vault-name trend-platform-vault \
#        --name openai-api-key --value "sk-proj-xxxxx"
#   4. Configure Azure AD Workload Identity for AKS
#
# This file is safe to commit (no secrets inside)
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trend-secret-reader
  namespace: trend-intelligence
  annotations:
    # Azure AD application client ID
    azure.workload.identity/client-id: "AZURE_CLIENT_ID"
    azure.workload.identity/tenant-id: "AZURE_TENANT_ID"
  labels:
    azure.workload.identity/use: "true"

---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-key-vault
  namespace: trend-intelligence
spec:
  provider:
    azurekv:
      vaultUrl: "https://trend-platform-vault.vault.azure.net"
      tenantId: "AZURE_TENANT_ID"
      authType: WorkloadIdentity
      serviceAccountRef:
        name: trend-secret-reader

---
# Sync OpenAI API Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: api-keys
    creationPolicy: Owner
  data:
    - secretKey: openai-api-key
      remoteRef:
        key: openai-api-key  # Secret name in Azure Key Vault
    - secretKey: youtube-api-key
      remoteRef:
        key: youtube-api-key

---
# Sync PostgreSQL credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: postgres-username
    - secretKey: password
      remoteRef:
        key: postgres-password

---
# Setup Commands (for reference):
#
# 1. Create Azure Key Vault:
#    az keyvault create \
#      --name trend-platform-vault \
#      --resource-group trend-platform \
#      --location eastus
#
# 2. Store secrets:
#    az keyvault secret set --vault-name trend-platform-vault \
#      --name openai-api-key --value "sk-proj-xxxxx"
#    az keyvault secret set --vault-name trend-platform-vault \
#      --name postgres-username --value "trend_user"
#    az keyvault secret set --vault-name trend-platform-vault \
#      --name postgres-password --value "secure-password"
#
# 3. Create Azure AD Application:
#    az ad sp create-for-rbac --name "trend-platform-secrets"
#
# 4. Grant Key Vault access:
#    az keyvault set-policy --name trend-platform-vault \
#      --spn <SERVICE_PRINCIPAL_ID> \
#      --secret-permissions get list
#
# 5. Enable Workload Identity on AKS:
#    az aks update --resource-group trend-platform \
#      --name trend-platform-cluster \
#      --enable-oidc-issuer \
#      --enable-workload-identity
#
# 6. Create federated credential:
#    az identity federated-credential create \
#      --name trend-platform-federated \
#      --identity-name trend-platform-identity \
#      --resource-group trend-platform \
#      --issuer $(az aks show --name trend-platform-cluster \
#        --resource-group trend-platform \
#        --query "oidcIssuerProfile.issuerUrl" -o tsv) \
#      --subject system:serviceaccount:trend-intelligence:trend-secret-reader
