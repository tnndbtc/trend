---
# Google Secret Manager Integration with External Secrets Operator
#
# Prerequisites:
#   1. Install External Secrets Operator (see README.md)
#   2. Store secrets in Google Secret Manager:
#      echo -n "sk-proj-xxxxx" | gcloud secrets create openai-api-key \
#        --data-file=- \
#        --replication-policy="automatic"
#   3. Create GCP Service Account with secretmanager.secretAccessor role
#   4. Enable Workload Identity for GKE cluster
#
# This file is safe to commit (no secrets inside)
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trend-secret-reader
  namespace: trend-intelligence
  annotations:
    # Link to GCP service account with Secret Manager access
    iam.gke.io/gcp-service-account: trend-platform@PROJECT_ID.iam.gserviceaccount.com

---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: google-secret-manager
  namespace: trend-intelligence
spec:
  provider:
    gcpsm:
      projectID: "PROJECT_ID"  # Your GCP project ID
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: trend-platform-cluster
          serviceAccountRef:
            name: trend-secret-reader

---
# Sync OpenAI API Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: api-keys
    creationPolicy: Owner
  data:
    - secretKey: openai-api-key
      remoteRef:
        key: openai-api-key  # Secret name in GCP Secret Manager
    - secretKey: youtube-api-key
      remoteRef:
        key: youtube-api-key

---
# Sync PostgreSQL credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: postgres-username
    - secretKey: password
      remoteRef:
        key: postgres-password

---
# Setup Commands (for reference):
#
# 1. Create GCP Service Account:
#    gcloud iam service-accounts create trend-platform \
#      --display-name="Trend Platform Secrets Access"
#
# 2. Grant Secret Manager access:
#    gcloud projects add-iam-policy-binding PROJECT_ID \
#      --member="serviceAccount:trend-platform@PROJECT_ID.iam.gserviceaccount.com" \
#      --role="roles/secretmanager.secretAccessor"
#
# 3. Enable Workload Identity:
#    gcloud iam service-accounts add-iam-policy-binding \
#      trend-platform@PROJECT_ID.iam.gserviceaccount.com \
#      --role roles/iam.workloadIdentityUser \
#      --member "serviceAccount:PROJECT_ID.svc.id.goog[trend-intelligence/trend-secret-reader]"
#
# 4. Store secrets:
#    echo -n "sk-proj-xxxxx" | gcloud secrets create openai-api-key --data-file=-
#    echo -n "trend_user" | gcloud secrets create postgres-username --data-file=-
#    echo -n "secure-password" | gcloud secrets create postgres-password --data-file=-
