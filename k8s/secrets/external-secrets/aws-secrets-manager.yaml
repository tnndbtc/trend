---
# AWS Secrets Manager Integration with External Secrets Operator
#
# Prerequisites:
#   1. Install External Secrets Operator (see README.md)
#   2. Store secrets in AWS Secrets Manager:
#      aws secretsmanager create-secret \
#        --name prod/trend-platform/openai-api-key \
#        --secret-string "sk-proj-xxxxx"
#   3. Configure IAM policy for pod to access secrets
#
# This file is safe to commit (no secrets inside)
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trend-secret-reader
  namespace: trend-intelligence
  annotations:
    # IAM role with secretsmanager:GetSecretValue permission
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/TrendPlatformSecretsRole

---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: trend-intelligence
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: trend-secret-reader

---
# Sync OpenAI API Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys
  namespace: trend-intelligence
spec:
  refreshInterval: 1h  # Check for updates every hour
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: api-keys  # Name of k8s secret to create
    creationPolicy: Owner
  data:
    - secretKey: openai-api-key  # Key in k8s secret
      remoteRef:
        key: prod/trend-platform/openai-api-key  # Path in AWS Secrets Manager
    - secretKey: youtube-api-key
      remoteRef:
        key: prod/trend-platform/youtube-api-key

---
# Sync PostgreSQL credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  dataFrom:
    # Import all keys from a JSON secret
    - extract:
        key: prod/trend-platform/postgres  # JSON: {"username":"trend_user","password":"xxxxx"}

---
# IAM Policy (for reference - apply via AWS console or Terraform)
#
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Action": [
#         "secretsmanager:GetSecretValue",
#         "secretsmanager:DescribeSecret"
#       ],
#       "Resource": [
#         "arn:aws:secretsmanager:us-east-1:ACCOUNT_ID:secret:prod/trend-platform/*"
#       ]
#     }
#   ]
# }
