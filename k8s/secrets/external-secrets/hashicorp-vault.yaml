---
# HashiCorp Vault Integration with External Secrets Operator
#
# Prerequisites:
#   1. Install External Secrets Operator (see README.md)
#   2. Deploy HashiCorp Vault (or use HCP Vault)
#   3. Enable Kubernetes auth method in Vault
#   4. Store secrets in Vault KV v2 engine
#
# This file is safe to commit (no secrets inside)
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: trend-secret-reader
  namespace: trend-intelligence

---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: trend-intelligence
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "secret"  # KV v2 engine path
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "trend-platform"
          serviceAccountRef:
            name: trend-secret-reader

---
# Sync OpenAI API Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-keys
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: api-keys
    creationPolicy: Owner
  data:
    - secretKey: openai-api-key
      remoteRef:
        key: trend-platform/api-keys  # Path in Vault
        property: openai-api-key       # Key within the secret
    - secretKey: youtube-api-key
      remoteRef:
        key: trend-platform/api-keys
        property: youtube-api-key

---
# Sync PostgreSQL credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: trend-intelligence
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: trend-platform/database
        property: username
    - secretKey: password
      remoteRef:
        key: trend-platform/database
        property: password

---
# Vault Setup Commands (for reference):
#
# 1. Enable Kubernetes auth:
#    vault auth enable kubernetes
#
# 2. Configure Kubernetes auth:
#    vault write auth/kubernetes/config \
#      kubernetes_host="https://kubernetes.default.svc:443"
#
# 3. Create policy:
#    vault policy write trend-platform - <<EOF
#    path "secret/data/trend-platform/*" {
#      capabilities = ["read"]
#    }
#    EOF
#
# 4. Create role:
#    vault write auth/kubernetes/role/trend-platform \
#      bound_service_account_names=trend-secret-reader \
#      bound_service_account_namespaces=trend-intelligence \
#      policies=trend-platform \
#      ttl=24h
#
# 5. Store secrets:
#    vault kv put secret/trend-platform/api-keys \
#      openai-api-key="sk-proj-xxxxx" \
#      youtube-api-key="your-youtube-key"
#
#    vault kv put secret/trend-platform/database \
#      username="trend_user" \
#      password="secure-password"
