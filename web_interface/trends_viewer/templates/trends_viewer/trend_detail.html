{% extends 'trends_viewer/base.html' %}
{% load source_filters %}

{% block title %}{{ trend.title }} - AI Trend Intelligence{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{% url 'trends_viewer:trend_list' %}" style="color: #3498db; text-decoration: none;">&larr; Back to Trends</a>
</div>

<div class="card" data-trend-id="{{ trend.id }}" data-original-title="{{ trend.title }}" data-original-summary="{{ trend.summary }}">
    <div style="display: flex; align-items: start; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-width: 80px; height: 80px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
            #{{ trend.rank }}
        </div>
        <div style="flex: 1;">
            <h2 style="margin-bottom: 1rem;" data-field="title">{{ trend.title }}</h2>
            <div style="display: flex; gap: 1.5rem; align-items: center; font-size: 0.875rem; color: #666; margin-bottom: 1rem;">
                <span>üìä Score: {{ trend.score|floatformat:0 }}</span>
                <span>üì∞ {{ topics.count }} topic{{ topics.count|pluralize }}</span>
                <span>üìÖ {{ trend.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div style="padding: 1rem; background: #f8f9fa; border-left: 4px solid #3498db; border-radius: 4px;">
                <p style="line-height: 1.6; color: #333;" data-field="summary">{{ trend.summary }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 1.5rem;">Related Topics ({{ topics.count }})</h3>

    {% if topics %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for topic in topics %}
        <div data-topic-id="{{ topic.id }}" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid {% if topic.source == 'reddit' %}#ff4500{% elif topic.source == 'hackernews' %}#ff6600{% else %}#4285f4{% endif %};">
            <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem; margin-bottom: 0.5rem;">
                <h4 style="flex: 1; font-size: 1rem;">
                    <a href="{{ topic.url }}" target="_blank" rel="noopener noreferrer" style="color: #2c3e50; text-decoration: none;" data-field="topic-title">
                        {{ topic.title }}
                    </a>
                </h4>
                <span class="badge badge-{{ topic.source|format_source_class }}">{{ topic|format_source_name }}</span>
            </div>

            {% if topic.description %}
            <p style="color: #666; font-size: 0.875rem; margin-bottom: 0.75rem; line-height: 1.5;" data-field="topic-description">
                {{ topic.description|truncatewords:50 }}
            </p>
            {% endif %}

            <div style="display: flex; gap: 1.5rem; font-size: 0.875rem; color: #666;">
                <span>üïí {{ topic.timestamp|date:"Y-m-d H:i" }}</span>
                {% if topic.upvotes %}
                <span>‚¨ÜÔ∏è {{ topic.upvotes }} upvotes</span>
                {% endif %}
                {% if topic.comments %}
                <span>üí¨ {{ topic.comments }} comments</span>
                {% endif %}
                {% if topic.score %}
                <span>‚≠ê {{ topic.score }} points</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center; color: #666; padding: 2rem;">No topics found for this trend.</p>
    {% endif %}
</div>

<script>
    /**
     * Lazy Translation on Page Load
     *
     * If a non-English language is requested via URL parameter,
     * this will automatically load translations client-side after
     * the English page loads (for optimal performance).
     */
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const requestedLang = urlParams.get('lang');

        // If a non-English language is requested
        if (requestedLang && requestedLang !== 'en') {
            console.log(`[LazyTranslation] Detected language request: ${requestedLang}`);

            // First, check localStorage cache
            const cachedTranslations = TranslationCache.get(requestedLang);

            if (cachedTranslations && Object.keys(cachedTranslations).length > 0) {
                // Apply cached translations immediately
                console.log(`[LazyTranslation] Using cached translations for ${requestedLang}`);
                applyTranslations(cachedTranslations, requestedLang);
            } else {
                // Show loading indicator
                showToast(`Loading ${getLanguageName(requestedLang)} translations...`, 5000);

                // Fetch and apply translations
                console.log(`[LazyTranslation] Fetching translations for ${requestedLang}`);
                fetchAndApplyTranslations(requestedLang);
            }
        }
    });
</script>

{% endblock %}
